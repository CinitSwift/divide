<!--æˆ¿é—´è¯¦æƒ…é¡µé¢-->
<view class="container" bindtap="onContainerTap">
  <!-- æˆ¿é—´ä¿¡æ¯å¤´éƒ¨ -->
  <view class="room-header card" catchtap="">
    <view class="game-info">
      <text class="game-name">ğŸ® {{room.gameName}}</text>
      <view class="room-code-box" bindtap="copyRoomCode">
        <text class="room-code">æˆ¿é—´å·: {{room.roomCode}}</text>
        <text class="copy-icon">ğŸ“‹</text>
      </view>
    </view>
    <view class="room-meta">
      <text class="owner-tag" wx:if="{{isOwner}}">æˆ‘æ˜¯æˆ¿ä¸»</text>
      <text class="status-tag status-{{room.status}}">
        {{room.status === 'waiting' ? 'ç­‰å¾…ä¸­' : room.status === 'divided' ? 'å·²åˆ†è¾¹' : 'å·²å…³é—­'}}
      </text>
    </view>
  </view>

  <!-- æˆå‘˜åˆ—è¡¨ -->
  <view class="members-section card" catchtap="">
    <view class="section-header">
      <text class="section-title">æˆ¿é—´æˆå‘˜</text>
      <text class="member-count">{{room.memberCount}}/{{room.maxMembers}}</text>
    </view>

    <view class="members-grid">
      <view
        class="member-item {{selectedMemberId === item.id ? 'selected' : ''}}"
        wx:for="{{room.members}}"
        wx:key="id"
        data-id="{{item.id}}"
        catchtap="onMemberTap"
      >
        <view class="avatar-wrapper">
          <image
            class="member-avatar"
            src="{{item.avatarUrl || '/images/default-avatar.png'}}"
            mode="aspectFill"
          ></image>
          <!-- åˆ é™¤å›¾æ ‡ - ä»…æˆ¿ä¸»å¯è§ä¸”é€‰ä¸­æ—¶æ˜¾ç¤º -->
          <view
            class="remove-icon"
            wx:if="{{isOwner && selectedMemberId === item.id && item.id !== room.ownerId}}"
            data-id="{{item.id}}"
            catchtap="onRemoveMember"
          >âœ•</view>
        </view>
        <text class="member-name">{{item.nickname || 'ç”¨æˆ·'}}</text>
        <text class="owner-badge" wx:if="{{item.id === room.ownerId}}">æˆ¿ä¸»</text>
      </view>

      <!-- ç©ºä½ -->
      <view class="member-item empty" wx:for="{{emptySlots}}" wx:key="index">
        <view class="empty-avatar">+</view>
        <text class="empty-text">ç­‰å¾…åŠ å…¥</text>
      </view>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’® -->
  <view class="action-section">
    <!-- æˆ¿ä¸»æ“ä½œ -->
    <block wx:if="{{isOwner}}">
      <button
        class="btn btn-success divide-btn"
        bindtap="handleDivide"
        disabled="{{room.memberCount < 2 || loading}}"
      >
        ğŸ² {{room.status === 'divided' ? 'é‡æ–°åˆ†è¾¹' : 'å¼€å§‹åˆ†è¾¹'}}
      </button>

      <button class="btn btn-secondary share-btn" open-type="share">
        ğŸ“¤ é‚€è¯·å¥½å‹
      </button>

      <button class="btn btn-danger close-btn" bindtap="handleCloseRoom">
        å…³é—­æˆ¿é—´
      </button>
    </block>

    <!-- éæˆå‘˜æ“ä½œ - æ˜¾ç¤ºåŠ å…¥æŒ‰é’® -->
    <block wx:elif="{{!isMember}}">
      <view class="join-tips">
        <text class="tips-icon">ğŸ‘‹</text>
        <text class="tips-text">æ‚¨è¿˜æœªåŠ å…¥æ­¤æˆ¿é—´</text>
      </view>

      <button
        class="btn btn-primary join-btn"
        bindtap="handleJoinRoom"
        disabled="{{loading || room.memberCount >= room.maxMembers}}"
      >
        ğŸšª {{room.memberCount >= room.maxMembers ? 'æˆ¿é—´å·²æ»¡' : 'åŠ å…¥æˆ¿é—´'}}
      </button>
    </block>

    <!-- æ™®é€šæˆå‘˜æ“ä½œ -->
    <block wx:else>
      <view class="waiting-tips" wx:if="{{room.status === 'waiting'}}">
        <text class="tips-icon">â³</text>
        <text class="tips-text">ç­‰å¾…æˆ¿ä¸»å¼€å§‹åˆ†è¾¹...</text>
      </view>

      <button class="btn btn-secondary leave-btn" bindtap="handleLeaveRoom">
        ç¦»å¼€æˆ¿é—´
      </button>
    </block>
  </view>
</view>
