<!--æˆ¿é—´è¯¦æƒ…é¡µé¢-->
<view class="container">
  <!-- æˆ¿é—´ä¿¡æ¯å¤´éƒ¨ -->
  <view class="room-header card" catchtap="">
    <!-- é¡¶éƒ¨æ“ä½œæŒ‰é’® -->
    <view class="header-actions">
      <button class="share-icon-btn" open-type="share">ğŸ“¤</button>
    </view>
    <view class="game-info">
      <text class="game-name">ğŸ® {{room.gameName}}</text>
      <view class="room-code-box" bindtap="copyRoomCode">
        <text class="room-code">æˆ¿é—´å·: {{room.roomCode}}</text>
        <text class="copy-icon">ğŸ“‹</text>
      </view>
    </view>
    <view class="room-meta">
      <view class="owner-tag" wx:if="{{isOwner}}">æˆ‘æ˜¯æˆ¿ä¸»</view>
      <view class="status-tag status-{{room.status}}">
        {{room.status === 'waiting' ? 'ç­‰å¾…ä¸­' : room.status === 'divided' ? 'å·²åˆ†è¾¹' : 'å·²å…³é—­'}}
      </view>
      <view class="close-room-btn" wx:if="{{isOwner}}" bindtap="handleCloseRoom">å…³é—­æˆ¿é—´</view>
    </view>
  </view>

  <!-- æˆå‘˜åˆ—è¡¨ -->
  <view class="members-section card" catchtap="">
    <view class="section-header">
      <text class="section-title">æˆ¿é—´æˆå‘˜</text>
      <text class="member-count">{{room.memberCount}}/{{room.maxMembers}}</text>
    </view>

    <!-- æˆ¿ä¸»æç¤ºï¼šç‚¹å‡»è®¾ç½®æ ‡ç­¾ï¼Œé•¿æŒ‰ç§»é™¤æˆå‘˜ -->
    <view class="label-tip" wx:if="{{isOwner && room.status === 'waiting'}}">
      <text>ğŸ’¡ ç‚¹å‡»å¤´åƒè®¾ç½®æ ‡ç­¾ï¼Œé•¿æŒ‰å¤´åƒç§»é™¤æˆå‘˜</text>
    </view>

    <view class="members-grid">
      <view
        class="member-item"
        wx:for="{{room.members}}"
        wx:key="id"
        data-id="{{item.id}}"
        catchtap="onMemberTap"
        bindlongpress="onMemberLongPress"
      >
        <view class="avatar-wrapper">
          <image
            wx:if="{{item.avatarUrl}}"
            class="member-avatar"
            src="{{item.avatarUrl}}"
            mode="aspectFill"
          ></image>
          <view wx:else class="member-avatar avatar-emoji">ğŸ˜Š</view>
        </view>
        <text class="member-name">{{item.nickname || 'ç”¨æˆ·'}}</text>
        <view class="owner-badge" wx:if="{{item.id === room.ownerId}}">æˆ¿ä¸»</view>
        <!-- æˆå‘˜æ ‡ç­¾æ˜¾ç¤º -->
        <view class="member-labels" wx:if="{{item.labels && item.labels.length > 0}}" data-member="{{item}}" data-id="{{item.id}}" catchtap="onLabelsTap" catchlongpress="onMemberLongPress">
          <view class="label-tag label-{{item.labels[0]}}" wx:if="{{item.labels[0]}}">
            {{item.labels[0] === 'god' ? 'å¹»ç¥' : item.labels[0] === 'sister' ? 'å¦¹å¦¹' : item.labels[0] === 'male' ? 'ç”·ç”Ÿ' : 'è€æ¿'}}
          </view>
          <view class="label-tag label-{{item.labels[1]}}" wx:if="{{item.labels[1]}}">
            {{item.labels[1] === 'god' ? 'å¹»ç¥' : item.labels[1] === 'sister' ? 'å¦¹å¦¹' : item.labels[1] === 'male' ? 'ç”·ç”Ÿ' : 'è€æ¿'}}
          </view>
          <view class="label-tag label-more" wx:if="{{item.labels.length > 2}}">...</view>
        </view>
      </view>

      <!-- ç©ºä½ -->
      <view class="member-item empty" wx:for="{{emptySlots}}" wx:key="index">
        <view class="empty-avatar">+</view>
        <text class="empty-text">ç­‰å¾…åŠ å…¥</text>
      </view>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’® -->
  <view class="action-section">
    <!-- æˆ¿ä¸»æ“ä½œ -->
    <block wx:if="{{isOwner}}">
      <!-- æ ‡ç­¾è§„åˆ™ + åˆ†è¾¹æŒ‰é’® åŒè¡Œ -->
      <view class="action-row" wx:if="{{room.status === 'waiting'}}">
        <button
          class="btn btn-secondary rule-btn"
          bindtap="openRuleModal"
        >
          ğŸ·ï¸ è®¾ç½®æ ‡ç­¾è§„åˆ™
        </button>
        <button
          class="btn btn-success divide-btn"
          bindtap="handleDivide"
          disabled="{{room.memberCount < 2 || loading}}"
        >
          ğŸ² å¼€å§‹åˆ†è¾¹
        </button>
      </view>

      <!-- å·²åˆ†è¾¹çŠ¶æ€ï¼Œåªæ˜¾ç¤ºé‡æ–°åˆ†è¾¹ -->
      <button
        class="btn btn-success divide-btn"
        bindtap="handleDivide"
        disabled="{{loading}}"
        wx:if="{{room.status === 'divided'}}"
      >
        ğŸ² é‡æ–°åˆ†è¾¹
      </button>
    </block>

    <!-- éæˆå‘˜æ“ä½œ - æ˜¾ç¤ºåŠ å…¥æŒ‰é’® -->
    <block wx:elif="{{!isMember}}">
      <view class="join-tips">
        <text class="tips-icon">ğŸ‘‹</text>
        <text class="tips-text">æ‚¨è¿˜æœªåŠ å…¥æ­¤æˆ¿é—´</text>
      </view>

      <button
        class="btn btn-primary join-btn"
        bindtap="handleJoinRoom"
        disabled="{{loading || room.memberCount >= room.maxMembers}}"
      >
        ğŸšª {{room.memberCount >= room.maxMembers ? 'æˆ¿é—´å·²æ»¡' : 'åŠ å…¥æˆ¿é—´'}}
      </button>
    </block>

    <!-- æ™®é€šæˆå‘˜æ“ä½œ -->
    <block wx:else>
      <view class="waiting-tips" wx:if="{{room.status === 'waiting'}}">
        <text class="tips-icon">â³</text>
        <text class="tips-text">ç­‰å¾…æˆ¿ä¸»å¼€å§‹åˆ†è¾¹...</text>
      </view>

      <button class="btn btn-secondary leave-btn" bindtap="handleLeaveRoom">
        ç¦»å¼€æˆ¿é—´
      </button>
    </block>
  </view>
</view>

<!-- æˆå‘˜æ ‡ç­¾è®¾ç½®å¼¹çª— -->
<view class="modal-mask" wx:if="{{showLabelModal}}" catchtap="closeLabelModal">
  <view class="modal-content" catchtap="preventBubble">
    <view class="modal-header">
      <text class="modal-title">è®¾ç½®æˆå‘˜æ ‡ç­¾</text>
      <text class="modal-subtitle">{{currentEditMember.nickname}}</text>
    </view>
    <view class="modal-body">
      <view class="label-list">
        <view
          class="label-option {{item.checked ? 'checked' : ''}}"
          wx:for="{{labelOptions}}"
          wx:key="key"
          data-key="{{item.key}}"
          catchtap="onLabelChange"
        >
          <view class="label-checkbox">
            <text wx:if="{{item.checked}}">âœ“</text>
          </view>
          <text class="label-name">{{item.name}}</text>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn cancel" catchtap="closeLabelModal">å–æ¶ˆ</button>
      <button class="modal-btn confirm" catchtap="saveMemberLabels" disabled="{{loading}}">ä¿å­˜</button>
    </view>
  </view>
</view>

<!-- æ ‡ç­¾è§„åˆ™è®¾ç½®å¼¹çª— -->
<view class="modal-mask" wx:if="{{showRuleModal}}" catchtap="closeRuleModal">
  <view class="modal-content rule-modal" catchtap="preventBubble">
    <view class="modal-header">
      <text class="modal-title">è®¾ç½®æ ‡ç­¾è§„åˆ™</text>
      <text class="modal-subtitle">åˆ†è¾¹æ—¶å°†æŒ‰è§„åˆ™åˆ†é…é˜Ÿä¼</text>
    </view>
    <view class="modal-body">
      <view class="rule-list">
        <view class="rule-item" wx:for="{{labelOptions}}" wx:key="key">
          <text class="rule-label">{{item.name}}</text>
          <picker
            mode="selector"
            range="{{ruleOptions}}"
            range-key="name"
            value="{{labelRules[item.key] === 'even' ? 1 : labelRules[item.key] === 'same_team' ? 2 : 0}}"
            data-label="{{item.key}}"
            bindchange="onRuleChange"
          >
            <view class="rule-picker">
              <text>{{labelRules[item.key] === 'even' ? 'å¹³å‡åˆ†åˆ°æ¯ä¸€é˜Ÿ' : labelRules[item.key] === 'same_team' ? 'å…¨éƒ¨åœ¨ä¸€è¾¹' : 'æ— è§„åˆ™'}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>
      </view>
      <view class="rule-note">
        <text>ğŸ’¡ æ³¨æ„ï¼šåªèƒ½æœ‰ä¸€ä¸ªæ ‡ç­¾è®¾ç½®ä¸º"å…¨éƒ¨åœ¨ä¸€è¾¹"</text>
      </view>
    </view>
    <view class="modal-footer">
      <button class="modal-btn cancel" catchtap="closeRuleModal">å–æ¶ˆ</button>
      <button class="modal-btn confirm" catchtap="saveLabelRules" disabled="{{loading}}">ä¿å­˜</button>
    </view>
  </view>
</view>

<!-- æŸ¥çœ‹æˆå‘˜æ‰€æœ‰æ ‡ç­¾å¼¹çª— -->
<view class="modal-mask" wx:if="{{showAllLabelsModal}}" catchtap="closeAllLabelsModal">
  <view class="modal-content all-labels-modal" catchtap="preventBubble">
    <view class="modal-header">
      <text class="modal-title">æˆå‘˜æ ‡ç­¾</text>
      <text class="modal-subtitle">{{viewLabelsMember.nickname}}</text>
    </view>
    <view class="modal-body">
      <view class="all-labels-list">
        <view class="label-tag-big label-{{label}}" wx:for="{{viewLabelsMember.labels}}" wx:for-item="label" wx:key="*this">
          {{label === 'god' ? 'å¹»ç¥' : label === 'sister' ? 'å¦¹å¦¹' : label === 'male' ? 'ç”·ç”Ÿ' : 'è€æ¿'}}
        </view>
      </view>
    </view>
    <view class="modal-footer single-btn">
      <button class="modal-btn confirm" catchtap="closeAllLabelsModal">çŸ¥é“äº†</button>
    </view>
  </view>
</view>
